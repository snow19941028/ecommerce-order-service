import java.time.LocalDateTime
import java.time.format.DateTimeFormatter
import java.time.ZoneId
import java.time.ZonedDateTime

ext {
    def cmd = "git rev-parse HEAD"
    def proc = cmd.execute()
    ext.gitRevision = proc.text.trim()
}


def buildNumber =
    System.getenv().getOrDefault("BUILD_NUMBER", "").trim()

def javaVersion = System.getProperties().getProperty("java.version").trim()

def branchName = System.getenv().getOrDefault("GIT_BRANCH", "").trim()

def commitNumber = System.getenv().getOrDefault("GIT_COMMIT", "").trim()

def buildDate = LocalDateTime
    .now()
    .format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"))


jar {
    baseName = group
    version = rootProject.version
    manifest {
        attributes(
            "Build-Number": buildNumber,
            "Branch": branchName,
            "Build-Date": buildDate,
            "X-Compile-Source-JDK": javaVersion,
            "X-Compile-Target-JDK": javaVersion,
            "Change": commitNumber
        )
    }
}

processResources {
    filesMatching("**/application*.yml") {
        expand([
                "buildNumber": System.getenv('GO_PIPELINE_LABEL') ?: "Local",
                "gitRevision": gitRevision,
                "buildTime"  : (ZonedDateTime.now((ZoneId.of("Asia/Shanghai")))).toString()
        ])
    }
}

